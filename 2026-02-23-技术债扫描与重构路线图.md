# Lead Architect Report: 技术债扫描与重构路线图

> 扫描日期：2026-02-23
> 扫描范围：music-lib 全仓库
> 执行角色：Lead Architect

---

## Codebase Profile

| 指标 | 数据 |
|------|------|
| 语言 | Go 1.18，纯标准库，零外部依赖 |
| 总代码量 | ~7,936 行 (不含测试) |
| 模块数量 | 10 个音乐平台 Provider + model/utils/provider 公共包 |
| 最大单文件 | `bilibili/bilibili.go` — 903 行 |
| 测试覆盖 | 仅集成测试 (依赖真实 API)，无 unit test |

### 文件行数统计

| 文件 | 行数 |
|------|------|
| bilibili/bilibili.go | 903 |
| soda/soda.go | 781 |
| kuwo/kuwo.go | 702 |
| qq/qq.go | 691 |
| netease/netease.go | 592 |
| migu/migu.go | 587 |
| fivesing/fivesing.go | 577 |
| kugou/kugou.go | 536 |
| joox/joox.go | 530 |
| qianqian/qianqian.go | 524 |
| jamendo/jamendo.go | 400 |
| soda/crypto.go | 247 |
| netease/crypto.go | 144 |
| utils/request.go | 89 |
| model/song.go | 89 |
| utils/file.go | 20 |
| provider/interface.go | 17 |

---

## 一、架构概览

### 1.1 项目结构

```
music-lib/
├── model/           # 共享数据结构 (Song, Playlist)
├── provider/        # 接口定义 (MusicProvider)
├── utils/           # HTTP 工具、文件处理、哈希
├── netease/         # 网易云音乐
├── qq/              # QQ音乐
├── kugou/           # 酷狗音乐
├── kuwo/            # 酷我音乐
├── migu/            # 咪咕音乐
├── qianqian/        # 千千音乐
├── soda/            # 汽水音乐
├── fivesing/        # 5sing
├── jamendo/         # Jamendo (国际)
├── bilibili/        # Bilibili
├── joox/            # JOOX
├── go.mod
├── song_test.go     # 平台功能测试
└── playlist_test.go # 歌单功能测试
```

### 1.2 核心接口

```go
type MusicProvider interface {
    Search(keyword string) ([]model.Song, error)
    Parse(link string) (*model.Song, error)
    GetDownloadURL(s *model.Song) (string, error)
    GetLyrics(s *model.Song) (string, error)
}
```

### 1.3 数据模型

```go
type Song struct {
    ID, Name, Artist, Album, AlbumID, Source, URL, Ext, Cover, Link string
    Duration, Bitrate int
    Size     int64
    Extra    map[string]string  // 平台特有元数据
    IsInvalid bool
}

type Playlist struct {
    ID, Name, Cover, Creator, Description, Source, Link string
    TrackCount, PlayCount int
    Extra map[string]string
}
```

### 1.4 工厂模式

每个 Provider 使用统一的工厂 + 默认单例模式：

```go
type Netease struct { cookie string }
func New(cookie string) *Netease { return &Netease{cookie: cookie} }
var defaultNetease = New("")
func Search(keyword string) ([]model.Song, error) {
    return defaultNetease.Search(keyword)
}
```

### 1.5 依赖关系

```
provider/interface.go
  └── model/song.go
        └── utils/file.go

[所有 10 个 Provider]
  ├── model/song.go
  ├── utils/request.go
  └── [平台特有加密] netease/crypto.go, soda/crypto.go
```

---

## 二、技术债清单 (Top 3)

### Debt #1: 巨型单文件 + 复合 ID 编码 — 结构性耦合 (严重)

**现象**：每个 Provider 都是一个 500~900 行的单文件，内含 Search / Parse / Download / Lyrics / Playlist 全部逻辑。

**次生问题 — 复合 ID**：3 个 Provider 将多字段拼入 `Song.ID`，后续用 `strings.Split(s.ID, "|")` 反解：

| Provider | ID 格式 | 构建位置 | 反解位置 |
|----------|---------|---------|---------|
| Bilibili | `bvid\|cid` | `bilibili.go:189,340,404,727,814` | `bilibili.go:846` |
| Migu | `contentID\|resourceType\|formatType` | `migu.go:498` | `migu.go:276,526` |
| Fivesing | `songID\|typeEname` | `fivesing.go:87,373,464` | `fivesing.go:415,532` |

`model.Song` 已有 `Extra map[string]string` 字段，这些数据本应存放在那里。

**影响**：无法单独测试某个功能；ID 编码脆弱，是运行时 panic 的隐患。

---

### Debt #2: 错误处理不一致 + 静默吞错 (中高)

**量化统计**：全项目共 **34 处** `_, _ =` 或 `_, _ :=`，即忽略了错误返回值。

分布如下：

| 文件 | 忽略错误次数 |
|------|------------|
| netease/netease.go | 9 |
| kuwo/kuwo.go | 7 |
| soda/crypto.go | 4 |
| bilibili/bilibili.go | 3 |
| migu/migu.go | 3 |
| qq/qq.go | 2 |
| netease/crypto.go | 2 |
| soda/soda.go | 2 |
| qianqian/qianqian.go | 1 |
| fivesing/fivesing.go | 1 |

**典型问题模式**：

1. **静默跳过失败批次** — `fetchPlaylistDetail` 批量拉取时 `if err == nil` 才追加，失败批次不报告
2. **元数据获取吞错** — 封面/歌词获取直接 `_ = err`，下游拿到空字符串无法排查
3. **错误上下文缺失** — `errors.New("download url not found")` 未携带 Provider 名、Song ID 等诊断信息

**影响**：生产环境难以排障；歌单数据不完整但表面"成功"。

---

### ~~Debt #2.5: 音质硬编码~~ (已修复 2026-02-24)

**已解决**：各 Provider 的 `GetDownloadURL` 之前硬编码了固定音质（QQ 只尝试 128k，网易云写死 320k，酷我从低到高尝试顺序反了）。现已通过前端全局音质设置 + `quality` query 参数传递 + Provider 动态降级解决。支持 `lossless`/`high`/`standard` 三档。

---

### Debt #3: 配置硬编码 + 跨 Provider 重复模式 (中)

**配置散落**：每个 Provider 文件头各自声明 `const Referer`, `const UserAgent`, `const SearchAPI`。API endpoint、加密密钥、Cookie 全部硬编码。`joox/joox.go` 硬编码了带 `session_key` 的完整 Cookie。

**重复样板代码 (×10)**：
- `New(cookie string)` 工厂函数 + `var defaultXxx = New("")` 单例
- 包级 wrapper 函数
- `interface{}` 多态字段解析 (共 33 处)
- `parseAnyInt` / `parseAnyString` 辅助逻辑多处重写

**影响**：增加新 Provider 时需复制大量样板；修改通用行为需改 10 个文件。

---

## 三、其他发现

### 3.1 `interface{}` 使用统计

共 33 处，主要用于处理 API 返回的 string/int 混合类型字段：

- `kuwo.go`: `ListenCnt`, `SongNum`, `Total`, `Count`, `MusicNum`, `Duration` — 6 处
- `netease.go`: `map[string]interface{}` 用于构建请求体 — 9 处
- `qq.go`: `map[string]interface{}` 请求体 — 5 处
- `kugou.go`: `Scid`, `FileSize`, `Error`, `ID` — 4 处
- `joox.go`: `KbpsMap` — 3 处
- `qianqian.go`: `ID` 字段 — 1 处

### 3.2 并发模式

仅 `fivesing.go` 使用了 goroutine + semaphore (chan 限制 10 并发)。其他 Provider 的歌单批量操作均为同步串行。

### 3.3 安全问题

- `joox/joox.go` 硬编码了包含 `session_key` 的完整 Cookie
- `jamendo/jamendo.go` 硬编码了 `ClientID`
- `netease/crypto.go` 包含 AES/RSA 加密密钥 (公开知识，风险有限)
- 无输入校验，搜索关键词直接传入 API

### 3.4 测试现状

- `song_test.go` (289 行) + `playlist_test.go` (218 行)
- 全部为集成测试，依赖真实 API
- 使用 `t.Parallel()` 并行
- 部分错误用 `t.Logf` 而非 `t.Errorf`，失败不会导致测试红灯
- `time.Sleep(2 * time.Second)` 硬编码延迟

---

## 四、重构路线图

### Phase A — 短期：结构解耦与防御性加固 (MVR)

| # | 目标 | 负责 Agent | 具体动作 |
|---|------|-----------|---------|
| A1 | **消除复合 ID** | @backend-core | Bilibili / Migu / Fivesing：将 `\|` 拼接的 ID 组件迁移至 `Song.Extra`，删除所有 `strings.Split(s.ID, "\|")` |
| A2 | **提取公共工具函数** | @backend-core | 将 `parseAnyInt`, `parseAnyString` 等收入 `utils/convert.go` |
| A3 | **错误链路加固** | @stability-engineer | 扫描 34 处忽略错误，补充 `fmt.Errorf("provider=%s id=%s: %w", ...)` |

**验收标准**：`go vet ./...` 通过；`go test ./...` 全绿；无 `strings.Split(*.ID, "|")` 残留。

### Phase B — 中期：模块化与可测试性

| # | 目标 | 负责 Agent | 具体动作 |
|---|------|-----------|---------|
| B1 | **Provider 文件拆分** | @interface-specialist | 每个 Provider 拆为 `search.go` / `playlist.go` / `download.go` / `lyrics.go` |
| B2 | **提取 Provider 基类** | @backend-core | 抽取 `BaseProvider` struct，承载 cookie、HTTP client、通用 wrapper |
| B3 | **配置外置** | @backend-core | 创建 `config/` 包，API endpoint / UA / 加密参数结构化，支持 `WithConfig()` |
| B4 | **Unit Test 基础设施** | @stability-engineer | 引入 `httptest` mock，编写不依赖真实 API 的单元测试 |

---

## 五、健康度评分

| 维度 | 得分 | 说明 |
|------|------|------|
| 模块化 | 7/10 | 接口设计好，但单文件过大 |
| 类型安全 | 8/10 | 核心类型清晰，`interface{}` 仅用于 JSON 兼容 |
| 错误处理 | 6/10 | 存在但不一致，34 处吞错 |
| 代码组织 | 6/10 | 目录结构清晰，文件内部组织差 |
| 测试覆盖 | 5/10 | 仅集成测试，无单元测试 |
| 性能 | 7/10 | 批量获取好，缺少缓存与并发 |
| 安全 | 5/10 | 硬编码凭据，无输入校验 |
| 可维护性 | 6/10 | 重复模式多，样板代码多 |
| 可扩展性 | 8/10 | 新增 Provider 容易（接口驱动） |

**综合：6.5 / 10**
